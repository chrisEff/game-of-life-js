(()=>{"use strict";class t{constructor(t,e,i,r,s,o){this.grid=t,this.canvas=e,this.context2D=e.getContext("2d"),this.width=i,this.height=r,this.intervalTime=s,this.interval=null,this.cellSize=o,this.running=!1,this.context2D.fillStyle="#000000",e.onclick=t=>{const e=this.grid.get(Math.floor(t.offsetY/(this.cellSize+1)),Math.floor(t.offsetX/(this.cellSize+1)));e.setAlive(!e.alive),this.drawCell(e)}}init=()=>{this.canvas.setAttribute("height",this.height*(this.cellSize+1)),this.canvas.setAttribute("width",this.width*(this.cellSize+1)),this.grid.init(this.width,this.height,this.cellSize),this.drawGuides()};reset=()=>{this.grid.reset(),this.drawFullFrame()};drawGuides=()=>{const t=this.cellSize+1,e=this.width*t,i=this.height*t;this.context2D.strokeStyle="#EEEEEE";for(let i=0;i<this.height;i+=5)this.context2D.moveTo(0,i*t),this.context2D.lineTo(e,i*t);for(let e=0;e<this.width;e+=5)this.context2D.moveTo(e*t,0),this.context2D.lineTo(e*t,i);this.context2D.stroke()};start=()=>{this.running=!0,0===this.intervalTime?window.requestAnimationFrame(this.doStep):this.interval=window.setInterval(this.doStep,this.intervalTime)};stop=()=>{this.running=!1,this.interval&&window.clearInterval(this.interval)};doStep=()=>{const t=this.grid.doStep();this.context2D.beginPath(),this.context2D.fillStyle="#FFFFFF";for(const e of t.toggleOff)e.toggle(),this.context2D.rect(e.xPos,e.yPos,this.cellSize,this.cellSize);this.context2D.fill(),this.context2D.closePath(),this.context2D.beginPath(),this.context2D.fillStyle="#000000";for(const e of t.toggleOn)e.toggle(),this.context2D.rect(e.xPos,e.yPos,this.cellSize,this.cellSize);this.context2D.fill(),this.context2D.closePath(),this.running&&0===this.intervalTime&&window.requestAnimationFrame(this.doStep)};drawFullFrame=()=>{const t=this.grid.cellArrayFlat;for(const e of t)this.drawCell(e)};drawCell=t=>{t.alive?this.context2D.fillRect(t.xPos,t.yPos,this.cellSize,this.cellSize):this.context2D.clearRect(t.xPos,t.yPos,this.cellSize,this.cellSize)};changeIntervalTime=t=>{const e=this.running;e&&this.stop(),window.localStorage.intervalTime=this.intervalTime=Number.parseInt(t),e&&this.start()};setWidth=t=>{t=Number.parseInt(t),window.localStorage.gridWidth=t;const e=this.grid.exportGrid();this.width=t,this.init(),this.grid.importGrid(e),this.drawFullFrame()};setHeight=t=>{t=Number.parseInt(t),window.localStorage.gridHeight=t;const e=this.grid.exportGrid();this.height=t,this.init(),this.grid.importGrid(e),this.drawFullFrame()};setCellSize=t=>{t=Number.parseInt(t),window.localStorage.cellSize=t;const e=this.grid.exportGrid();this.cellSize=t,this.init(),this.grid.importGrid(e),this.drawFullFrame()};loadPattern=async(t,e=!1,i=0,r=0)=>{if(e&&this.reset(),t){const e=await fetch(`patterns/${t}.rle`);this.grid.importRLE(await e.text(),i,r)}this.drawFullFrame()}}class e{constructor(t,e,i){this.xPos=t*(i+1),this.yPos=e*(i+1),this.alive=!1,this.livingNeighborCount=0}setNeighbors(t){this.neighbors=t}setAlive(t){this.alive!==t&&this.toggle()}toggle(){if(this.alive=!this.alive,this.alive)for(const t of this.neighbors)t.livingNeighborCount++;else for(const t of this.neighbors)t.livingNeighborCount--}}class i{constructor(){this.cellArray=[],this.cellArrayFlat=[]}get=(t,e)=>this.cellArray[t][e];init=(t,i,r)=>{this.cellArray=[],this.cellArrayFlat=[];for(let s=0;s<i;s++){const i=[];for(let o=0;o<t;o++){const t=new e(o,s,r);i.push(t),this.cellArrayFlat.push(t)}this.cellArray.push(i)}for(let e=0;e<i;e++)for(let i=0;i<t;i++)this.cellArray[e][i].setNeighbors(this.getNeighbors(i,e))};getNeighbors(t,e){const i=[];for(const r of[{x:t-1,y:e-1},{x:t-1,y:e},{x:t-1,y:e+1},{x:t,y:e-1},{x:t,y:e+1},{x:t+1,y:e-1},{x:t+1,y:e},{x:t+1,y:e+1}])try{const t=this.cellArray[r.y][r.x];t&&i.push(t)}catch(t){if(!(t instanceof TypeError))throw t}return i}reset=()=>{for(const t of this.cellArrayFlat)t.setAlive(!1)};randomize=()=>{for(const t of this.cellArrayFlat)t.setAlive(Boolean(Math.round(Math.random())))};doStep=()=>{const t={toggleOn:[],toggleOff:[]};for(const e of this.cellArrayFlat)e.alive?(e.livingNeighborCount<2||e.livingNeighborCount>3)&&t.toggleOff.push(e):3===e.livingNeighborCount&&t.toggleOn.push(e);return t};importGrid=(t,e=0,i=0)=>{-1===e&&(e=Math.max(0,Math.floor((this.cellArray[0].length-t[0].length)/2))),-1===i&&(i=Math.max(0,Math.floor((this.cellArray.length-t.length)/2)));const r=Math.min(t.length+i,this.cellArray.length),s=Math.min(t[0].length+e,this.cellArray[0].length);for(let o=i;o<r;o++)for(let r=e;r<s;r++)this.cellArray[o][r].setAlive(Boolean(t[o-i][r-e]))};exportGrid=(t=!1)=>{const e=this.cellArray.map((t=>t.map((t=>t.alive?1:0))));if(t)for(;e.length;){const t=e.pop();if(t.includes(1)){e.push(t);break}}return e};importJson=(t,e=0,i=0)=>{this.importGrid(JSON.parse(t),e,i)};exportJson=()=>JSON.stringify(this.exportGrid(!0)).replace(/],/g,"],\n").replace("[[","[\n[").replace("]]","]\n]");importRLE=(t,e=0,i=0)=>{let r=0,s=[];for(const e of t.split("\n").filter((t=>!t.startsWith("#"))).join("").replace(/\n/g,"").split("$")){const t=e.split("");let i="";const o=[];for(;t.length;){const e=t.shift();if("b"===e||"o"===e){""===i&&(i=1);for(let t=0;t<Number.parseInt(i);t++)o.push("o"===e?1:0);i=""}else i+=e}if(s.push(o),""!==i)for(let t=1;t<Number.parseInt(i);t++)s.push([0]);r=Math.max(r,o.length)}s=s.map((t=>{const e=t.length;return t.length=r,t.fill(0,e)})),this.importGrid(s,e,i)};exportRLE=()=>{let t="",e=-1,i=0;const r=this.exportGrid(!0);for(const s of r){if(s.filter((t=>t)).length<1){e++;continue}e>0?(t+=`${e+1}$`,i+=`${e+1}$`.length):0===e&&(t+="$",i+=1),e=0;let r=1,o=null;for(const e of s)if(e===o)r++;else{if(null!==o){const e=`${r>1?r:""}${o?"o":"b"}`;t+=e,i+=e.length,i>=120&&(t+="\n",i=0)}r=1,o=e}o&&(t+=`${r>1?r:""}o`)}return t};hflip=()=>{const t=this.exportGrid();for(const e of t)e.reverse();this.importGrid(t)};vflip=()=>{this.importGrid(this.exportGrid().reverse())};shiftUp=()=>{const t=this.exportGrid();t.shift(),t.push(Array.from({length:this.cellArray[0].length}).fill(0)),this.importGrid(t)};shiftDown=()=>{const t=this.exportGrid();t.unshift(Array.from({length:this.cellArray[0].length}).fill(0)),this.importGrid(t)};shiftLeft=()=>{const t=this.exportGrid();for(const e of t)e.shift(),e.push(0);this.importGrid(t)};shiftRight=()=>{const t=this.exportGrid();for(const e of t)e.unshift(0);this.importGrid(t)};rotate=()=>{const t=this.exportGrid(),e=[];for(let i=0;i<t[0].length;i++){const r=t.map((t=>t[i])).reverse();e.push(r)}this.importGrid(e)}}class r{getJson(t){const e=localStorage.getItem(t);return e?JSON.parse(e):null}setJson(t,e){localStorage.setItem(t,JSON.stringify(e))}setObjectProperty(t,e,i){const r=this.getJson(t)||{};r[e]=i,this.setJson(t,r)}}const s=t=>document.querySelector(t);document.addEventListener("DOMContentLoaded",(()=>{const e=new r,o=e.getJson("displayStates")||{};for(const[t,e]of Object.entries(o))s("#"+t).style.display=e;HTMLElement.prototype.toggle=function(t="initial"){this.style.display=["","none"].includes(this.style.display)?t:"none",e.setObjectProperty("displayStates",this.id,this.style.display)},s("#version").innerHTML="v1.6.0";const l=new i,n=new t(l,s("#canvas"),Number.parseInt(window.localStorage.gridWidth)||128,Number.parseInt(window.localStorage.gridHeight)||128,Number.parseInt(window.localStorage.intervalTime)||1,Number.parseInt(window.localStorage.cellSize)||4);n.init(),s("#gridHeight").value=n.height,s("#gridWidth").value=n.width,s("#cellSize").value=n.cellSize,s("#intervalTime").value=n.intervalTime;const h=()=>{s("#start").style.display="none",s("#stop").style.display="initial",n.start()},a=()=>{s("#start").style.display="initial",s("#stop").style.display="none",n.stop()},c={s:()=>n.running?a():h(),t:s("#step").onclick=n.doStep,r:s("#reset").onclick=n.reset,h:s("#hflip").onclick=()=>{l.hflip(),n.drawFullFrame()},v:s("#vflip").onclick=()=>{l.vflip(),n.drawFullFrame()},o:s("#rotate").onclick=()=>{l.rotate(),n.drawFullFrame()},a:s("#randomize").onclick=()=>{l.randomize(),n.drawFullFrame()},ArrowDown:s("#down").onclick=()=>{l.shiftDown(),n.drawFullFrame()},ArrowUp:s("#up").onclick=()=>{l.shiftUp(),n.drawFullFrame()},ArrowLeft:s("#left").onclick=()=>{l.shiftLeft(),n.drawFullFrame()},ArrowRight:s("#right").onclick=()=>{l.shiftRight(),n.drawFullFrame()}};s("#start").onclick=h,s("#stop").onclick=a,s("#runBenchmark").onclick=()=>{const t=s("#benchmarkSteps").value,e=performance.now();for(let e=0;e<t;e++)n.doStep();console.log(`Executing ${t} steps took ${performance.now()-e}ms.`)};for(const t of Array.from(document.querySelectorAll(".pattern")))t.onclick=t=>(t.target.blur(),n.loadPattern(t.target.value||t.target.innerHTML,s("#resetBeforeLoad").checked,document.forms.settings.offsetXcenter.value?-1:Number.parseInt(s("#offsetX").value),document.forms.settings.offsetYcenter.value?-1:Number.parseInt(s("#offsetY").value)));s("#gridWidth").onchange=t=>n.setWidth(t.target.value),s("#gridHeight").onchange=t=>n.setHeight(t.target.value),s("#cellSize").onchange=t=>n.setCellSize(t.target.value),s("#intervalTime").onchange=t=>n.changeIntervalTime(t.target.value),s("#numbersLettersLabel").onclick=()=>s("#numbersLetters").toggle("block"),s("#gliderGunsLabel").onclick=()=>s("#gliderGuns").toggle("flex"),s("#corderShipsLabel").onclick=()=>s("#corderShips").toggle("flex"),s("#miscLabel").onclick=()=>s("#misc").toggle("flex"),s("#import").onclick=()=>{const t=s("#importExport").value,e=document.forms.settings.offsetXcenter.value?-1:Number.parseInt(s("#offsetX").value),i=document.forms.settings.offsetYcenter.value?-1:Number.parseInt(s("#offsetY").value);s("#resetBeforeLoad").checked&&n.reset(),(t=>{try{return JSON.parse(t),!0}catch(t){return console.log("isJSON caught:",t),!1}})(t)?l.importJson(t,e,i):l.importRLE(t,e,i),n.drawFullFrame()},s("#exportJSON").onclick=()=>s("#importExport").value=l.exportJson(),s("#exportRLE").onclick=()=>s("#importExport").value=l.exportRLE(),document.addEventListener("keydown",(t=>{t.metaKey||t.ctrlKey||"body"!==t.target.tagName.toLowerCase()||!Object.prototype.hasOwnProperty.call(c,t.key)||(c[t.key](),t.preventDefault())}))}))})();